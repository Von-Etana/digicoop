generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  MEMBER
  ADMIN
  VENDOR
}

enum KycStatus {
  PENDING
  VERIFIED
  FAILED
}

enum TransactionType {
  DEPOSIT
  WITHDRAWAL
  SAVINGS_CONTRIBUTION
  LOAN_DISBURSEMENT
  LOAN_REPAYMENT
  GROUP_BUY
  INVESTMENT
  DIVIDEND
}

enum TransactionStatus {
  SUCCESS
  PENDING
  FAILED
}

enum SavingsType {
  COMPULSORY
  VOLUNTARY
  GOAL
}

enum LoanStatus {
  PENDING
  APPROVED
  REJECTED
  ACTIVE
  PAID
  DEFAULTED
}

enum EventStatus {
  UPCOMING
  PAST
  CANCELLED
}

enum RsvpStatus {
  GOING
  NOT_GOING
  MAYBE
}

model User {
  id           String    @id @default(uuid())
  email        String    @unique
  phoneNumber  String    @unique
  passwordHash String
  fullName     String
  bvn          String?   @unique
  nin          String?   @unique
  kycStatus    KycStatus @default(PENDING)
  membershipId String?   @unique
  role         Role      @default(MEMBER)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  wallet      Wallet?
  savings     SavingsGoal[]
  loans       Loan[]
  orders      GroupBuyOrder[]
  investments Investment[]
  votes       Vote[]
  eventRsvps  EventRsvp[]
}

model Wallet {
  id        String   @id @default(uuid())
  userId    String   @unique
  user      User     @relation(fields: [userId], references: [id])
  balance   Decimal  @default(0.00) @db.Decimal(12, 2)
  currency  String   @default("NGN")
  updatedAt DateTime @updatedAt

  transactions Transaction[]
}

model Transaction {
  id          String            @id @default(uuid())
  walletId    String
  wallet      Wallet            @relation(fields: [walletId], references: [id])
  type        TransactionType
  amount      Decimal           @db.Decimal(12, 2)
  description String
  reference   String?           @unique // Payment gateway reference
  status      TransactionStatus @default(PENDING)
  metadata    Json? // Stores extra data like loanId, savingsId
  createdAt   DateTime          @default(now())
}

model SavingsGoal {
  id            String      @id @default(uuid())
  userId        String
  user          User        @relation(fields: [userId], references: [id])
  title         String
  targetAmount  Decimal     @db.Decimal(12, 2)
  currentAmount Decimal     @default(0) @db.Decimal(12, 2)
  type          SavingsType
  locked        Boolean     @default(false)
  dueDate       DateTime?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
}

model Loan {
  id             String     @id @default(uuid())
  userId         String
  user           User       @relation(fields: [userId], references: [id])
  amount         Decimal    @db.Decimal(12, 2)
  purpose        String
  interestRate   Decimal    @db.Decimal(5, 2) // Monthly interest
  durationMonths Int
  status         LoanStatus @default(PENDING)
  disbursedAt    DateTime?
  dueDate        DateTime?
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt
}

model GroupBuyItem {
  id                   String   @id @default(uuid())
  name                 String
  description          String
  imageUrl             String
  pricePerUnit         Decimal  @db.Decimal(12, 2)
  minOrderQuantity     Int
  currentOrderQuantity Int      @default(0)
  maxOrderQuantity     Int?
  deadline             DateTime
  vendorId             String? // Optional link to a vendor user
  createdAt            DateTime @default(now())

  orders GroupBuyOrder[]
}

model GroupBuyOrder {
  id         String       @id @default(uuid())
  userId     String
  user       User         @relation(fields: [userId], references: [id])
  itemId     String
  item       GroupBuyItem @relation(fields: [itemId], references: [id])
  quantity   Int
  totalPrice Decimal      @db.Decimal(12, 2)
  status     String       @default("PAID") // PAID, REFUNDED
  createdAt  DateTime     @default(now())
}

model InvestmentProject {
  id             String   @id @default(uuid())
  title          String
  description    String
  pitch          String? // URL to docs/video
  targetAmount   Decimal  @db.Decimal(15, 2)
  raisedAmount   Decimal  @default(0) @db.Decimal(15, 2)
  roiPercentage  Decimal  @db.Decimal(5, 2)
  durationMonths Int
  closingDate    DateTime
  createdAt      DateTime @default(now())

  investments Investment[]
}

model Investment {
  id        String            @id @default(uuid())
  userId    String
  user      User              @relation(fields: [userId], references: [id])
  projectId String
  project   InvestmentProject @relation(fields: [projectId], references: [id])
  amount    Decimal           @db.Decimal(12, 2)
  createdAt DateTime          @default(now())
}

model Poll {
  id        String   @id @default(uuid())
  question  String
  endDate   DateTime
  createdAt DateTime @default(now())

  options PollOption[]
  votes   Vote[]
}

model PollOption {
  id     String @id @default(uuid())
  pollId String
  poll   Poll   @relation(fields: [pollId], references: [id])
  text   String

  votes Vote[]
}

model Vote {
  id        String     @id @default(uuid())
  pollId    String
  poll      Poll       @relation(fields: [pollId], references: [id])
  optionId  String
  option    PollOption @relation(fields: [optionId], references: [id])
  userId    String
  user      User       @relation(fields: [userId], references: [id])
  createdAt DateTime   @default(now())

  @@unique([pollId, userId]) // One vote per poll per user
}

model Event {
  id        String      @id @default(uuid())
  title     String
  date      DateTime
  location  String
  imageUrl  String?
  status    EventStatus @default(UPCOMING)
  createdAt DateTime    @default(now())

  rsvps EventRsvp[]
}

model EventRsvp {
  id        String     @id @default(uuid())
  eventId   String
  event     Event      @relation(fields: [eventId], references: [id])
  userId    String
  user      User       @relation(fields: [userId], references: [id])
  status    RsvpStatus
  createdAt DateTime   @default(now())

  @@unique([eventId, userId])
}

model Notification {
  id        String   @id @default(uuid())
  userId    String
  title     String
  message   String
  isRead    Boolean  @default(false)
  type      String // SYSTEM, SAVINGS, LOAN, ETC
  createdAt DateTime @default(now())
}
